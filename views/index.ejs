<!DOCTYPE html>
<html>
<head>
  <title>Music Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="/css/music.css" >
</head>

<body>
  <!-- ğŸ§ Header Section -->
  <header class="header">
    <!-- ğŸ”™ Back to Main Menu -->
    <div class="back-button">
      <form action="/" method="GET">
        <button>â¬…ï¸ Back to Main Menu</button>
      </form>
    </div>
    <!-- ğŸ¶ Now Playing -->
    <div class="now-playing">
      <h3>Now Playing</h3>
      <p id="nowPlayingText">Loading...</p>
      <span class="playing-indicator" style="display:none;"></span>
    </div>
    <!-- ğŸ”§ Playback Controls -->
    <div class="box controls">
      <form action="/prev-track" method="POST" style="display:inline;">
        <button>â®ï¸ Previous</button>
      </form>
      <form action="/toggle-pause" method="GET" style="display:inline;">
        <button>â¯ï¸ Pause/Resume</button>
      </form>
      <form action="/next-track" method="POST" style="display:inline;">
        <button>â­ï¸ Next</button>
      </form>
      <div style="margin-top: 1em;">
        <h3>ğŸš Volume Control</h3>
        <form action="/volume/up" method="POST" style="display: inline;">
          <button type="submit">ğŸ”Š Volume +</button>
        </form>
        <form action="/volume/down" method="POST" style="display: inline;">
          <button type="submit">ğŸ”‰ Volume -</button>
        </form>
        </div>
    </div>

    <!-- ğŸ”Š Volume & Playlist Controls -->


      <div class="playlist-controls">
        <!-- ğŸ’¾ Save Playlist -->
        <button id="savePlaylistBtn">ğŸ’¾ Save Playlist</button>

        <!-- ğŸ“ Playlist Name Dialog -->
        <div id="playlistDialog" style="display:none;">
          <label for="playlistName">Enter playlist name:</label>
          <input type="text" id="playlistName" />
          <button id="confirmSaveBtn">âœ… Save</button>
          <button id="cancelSaveBtn">âŒ Cancel</button>
        </div>
      </div>

      <!-- ğŸ“‚ Open Playlist -->
      <button id="openBtn">ğŸ“‚ Open Playlist</button>
      <div id="playlistSelector" style="display:none;">
        <label for="playlistDropdown">Select a playlist:</label>
        <select id="playlistDropdown"></select>
        <button id="loadSelectedBtn">âœ… Load</button>
        <button id="cancelLoadBtn">âŒ Cancel</button>
      </div>

      <!-- â–¶ï¸ Play Queue -->
      <form action="/play-queue" method="POST" onsubmit="setTimeout(() => location.reload(), 500);">
        <button type="submit">â–¶ï¸ Play Queue</button>
      </form>
    </div>

    <!-- ğŸŒ¡ï¸ CPU Temp & Errors -->
    <p><strong>CPU Temp:</strong> <%= tempOutput %></p>
    <div class="error-area">
      <% if (currentTrack.title !== 'No track playing' && typeof playbackError !== 'undefined') { %>
        <p class="error-msg">âš ï¸ <%= playbackError %></p>
      <% } %>
    </div>
  </header>

  <!-- ğŸ—‚ï¸ Two-Column Main Layout -->
  <div class="main-layout">
    <!-- ğŸµ Track List (Left Column) -->
    <div class="track-list box">
      <% if (isTrackView) { %>
        <h3>Tracks</h3>
        <form action="/music/up" method="GET">
          <button class="back-btn">â¬…ï¸ Back</button>
        </form>
        <ul>
          <% entries.forEach(entry => { %>
            <li>
              <%= entry.name %>
              <form class="enqueue-form" action="/enqueue" method="GET" style="display:inline;">
                <input type="hidden" name="file" value="<%= entry.relPath %>">
                <button class="enqueue-btn">â• Add to Queue</button>
              </form>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <h3>Folders</h3>
        <ul>
          <% entries.forEach(entry => { %>
            <li>
              <a href="/music?dir=<%= encodeURIComponent(entry.relPath) %>">
                ğŸ“ <%= entry.name %>
              </a>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <!-- ğŸ“‹ Queue List (Right Column) -->
    <div class="queue-list box">
      <h3>Current Queue</h3>
      <ul>
        <% queue.forEach((track, index) => { %>
          <li>
            <%= track %>
            <form action="/queue/remove/<%= index %>" method="POST" style="display:inline;">
              <button class="remove-btn">ğŸ—‘ï¸ Remove</button>
            </form>
          </li>
        <% }) %>
      </ul>
    </div>
  </div>


  <script>
  
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.enqueue-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const params = new URLSearchParams(formData).toString();
      const url = `${form.action}?${params}`;

      try {
        const res = await fetch(url);
        const result = await res.json();

        if (result.success) {
          console.log('Track enqueued:', result.track);
          refreshQueueList(); // âœ… Call frontend function to update queue
        } else {
          alert(`Error: ${result.message}`);
        }
      } catch (err) {
        console.error('Enqueue failed:', err);
      }
    });
});

  });

  async function refreshQueueList() {
  try {
    const res = await fetch('/queue');
    const result = await res.json();

    if (result.success) {
      const queueList = document.querySelector('.queue-list ul');
      queueList.innerHTML = ''; // Clear current list

      result.queue.forEach((track, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${track}
          <form action="/queue/remove/${index}" method="POST" style="display:inline;">
            <button class="remove-btn">ğŸ—‘ï¸ Remove</button>
          </form>
        `;
        queueList.appendChild(li);
      });
    } else {
      console.error('Failed to refresh queue:', result.message);
    }
  } catch (err) {
    console.error('Error fetching queue:', err);
  }
}

  
  document.getElementById('openBtn').onclick = async () => {
    const res = await fetch('/playlist/list');
    const result = await res.json();
    console.log("Generating dropdown")
    if (result.success) {
      const dropdown = document.getElementById('playlistDropdown');
      dropdown.innerHTML = ''; // Clear previous options

      result.playlists.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        dropdown.appendChild(option);
      });

      document.getElementById('playlistSelector').style.display = 'block';
    } else {
      alert('Failed to load playlist list');
    }
  };

  document.getElementById('loadSelectedBtn').onclick = async () => {
    const name = document.getElementById('playlistDropdown').value;
    const res = await fetch(`/load-playlist/${encodeURIComponent(name)}`);
    const result = await res.json();

    if (result.success) {
      alert(`Loaded ${name} into queue!`);
      location.reload(); // Refresh to show updated queue
    } else {
      alert(`Error: ${result.message}`);
    }
  };

  document.getElementById('cancelLoadBtn').onclick = () => {
    document.getElementById('playlistSelector').style.display = 'none';
  };
  document.getElementById('backBtn').onclick = async () => {
  const res = await fetch('/go-back');
  const result = await res.json();
  // Refresh your UI with result.contents
};

  async function refreshNowPlaying() {
  try {
    const res = await fetch('/now-playing');
    const track = await res.json();

    const nowPlayingText = document.getElementById('nowPlayingText');
    const indicator = document.querySelector('.playing-indicator');
    console.log("Refreshing Now Playing");
    nowPlayingText.innerText = `${track.artist} - ${track.title}`;

    if (track.title !== 'No track playing') {
      indicator.style.display = 'inline-block';
      indicator.classList.add('active');
    } else {
      indicator.style.display = 'none';
      indicator.classList.remove('active');
    }
  } catch (err) {
    console.error('Failed to fetch now playing:', err);
  }
};

setInterval(refreshNowPlaying, 5000);
refreshNowPlaying();

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('openBtn').onclick = async () => {
      const res = await fetch('/playlist/list');
      const result = await res.json();
      console.log("getting playlists...")

      if (result.success) {
        const dropdown = document.getElementById('playlistDropdown');
        dropdown.innerHTML = ''; // Clear previous options

        result.playlists.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        });

        document.getElementById('playlistSelector').style.display = 'block';
      } else {
        alert('Failed to load playlist list');
      }
    };

    document.getElementById('loadSelectedBtn').onclick = async () => {
      const name = document.getElementById('playlistDropdown').value;
      const res = await fetch(`/load-playlist/${encodeURIComponent(name)}`);
      const result = await res.json();

      if (result.success) {
        alert(`Loaded ${name} into queue!`);
        location.reload();
      } else {
        alert(`Error: ${result.message}`);
      }
    };

    document.getElementById('cancelLoadBtn').onclick = () => {
      document.getElementById('playlistSelector').style.display = 'none';
    };
  });
</script>
</body>
</html>

